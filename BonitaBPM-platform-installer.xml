<project>
    <shortName>BonitaBPMPlatform</shortName>
    <fullName>BonitaBPM Platform</fullName>
    <version>1.0</version>
    <allowLanguageSelection>1</allowLanguageSelection>
    <componentList>
        <component>
            <name>jre</name>
            <description>JRE</description>
            <canBeEdited>1</canBeEdited>
            <selected>0</selected>
            <show>1</show>
            <folderList>
                <folder>
                    <description>Java Runtime Environment</description>
                    <destination>${jreinstalldir}</destination>
                    <name>jre</name>
                    <platforms>all</platforms>
                </folder>
            </folderList>
            <parameterList>
                <directoryParameter>
                    <name>jreinstalldir</name>
                    <title>jre.installdir.title</title>
                    <description>jre.installdir.label</description>
                    <explanation>jre.installdir.description</explanation>
                    <value></value>
                    <default>${installdir}</default>
                    <allowEmptyValue>0</allowEmptyValue>
                    <cliOptionName>jre_install_dir</cliOptionName>
                    <mustBeWritable>1</mustBeWritable>
                    <mustExist>0</mustExist>
                    <width>40</width>
                </directoryParameter>
            </parameterList>
            <postInstallationActionList>
                <setInstallerVariable>
                    <name>jrePlatform</name>
                    <value>jre1.7.0_55-linux</value>
                    <ruleList>
                        <platformTest>
                            <type>linux-x86</type>
                        </platformTest>
                    </ruleList>
                </setInstallerVariable>
                <setInstallerVariable>
                    <name>jrePlatform</name>
                    <value>jre1.7.0_55-linux-x64</value>
                    <ruleList>
                        <platformTest>
                            <type>linux-x64</type>
                        </platformTest>
                    </ruleList>
                </setInstallerVariable>
                <setInstallerVariable>
                    <name>jrePlatform</name>
                    <value>jre1.7.0_55-windows</value>
                    <ruleList>
                        <platformTest>
                            <type>windows-x86</type>
                        </platformTest>
                    </ruleList>
                </setInstallerVariable>
                <setInstallerVariable>
                    <name>jrePlatform</name>
                    <value>jre1.7.0_55-windows-x64</value>
                    <ruleList>
                        <platformTest>
                            <type>windows-x64</type>
                        </platformTest>
                    </ruleList>
                </setInstallerVariable>
                <setInstallerVariable>
                    <name>jrePlatform</name>
                    <value>jre1.7.0_55-osx</value>
                    <ruleList>
                        <platformTest>
                            <type>osx-intel</type>
                        </platformTest>
                    </ruleList>
                </setInstallerVariable>
                <httpGet>
                    <filename>${jreinstalldir}/jre.zip</filename>
                    <url>http://repositories.rd.lan/tools/studio-tools/${jrePlatform}.zip</url>
                </httpGet>
                <unzip>
                    <destinationDirectory>${jreinstalldir}</destinationDirectory>
                    <zipFile>${jreinstalldir}/jre.zip</zipFile>
                </unzip>
                <deleteFile>
                    <path>${jreinstalldir}/jre7.zip</path>
                </deleteFile>
                <setInstallerVariable>
                    <name>jre_home</name>
                    <value>${jreinstalldir}/${jrePlatform}/jre</value>
                </setInstallerVariable>
                <changePermissions>
                    <files>${jre_home}/bin/*</files>
                    <permissions>755</permissions>
                </changePermissions>
            </postInstallationActionList>
        </component>
        <component>
            <name>bonitaPlatform</name>
            <description>BonitaBPM Platform</description>
            <canBeEdited>0</canBeEdited>
            <selected>1</selected>
            <show>1</show>
            <parameterList>
                <directoryParameter>
                    <name>installdir</name>
                    <description>Installer.Parameter.installdir.description</description>
                    <explanation>Installer.Parameter.installdir.explanation</explanation>
                    <value></value>
                    <default>${platform_install_prefix}/${product_shortname}-${product_version}</default>
                    <allowEmptyValue>0</allowEmptyValue>
                    <cliOptionName>install_dir</cliOptionName>
                    <mustBeWritable>1</mustBeWritable>
                    <mustExist>0</mustExist>
                    <width>40</width>
                </directoryParameter>
                <parameterGroup>
                    <name>platformConfiguration</name>
                    <title>Platform configuration</title>
                    <explanation>Platform configuration</explanation>
                    <value></value>
                    <default></default>
                    <parameterList>
                        <stringParameter>
                            <name>tomcatPort</name>
                            <title>Tomcat port</title>
                            <description>Tomcat port</description>
                            <explanation></explanation>
                            <value></value>
                            <default>${tomcatDefaultPort}</default>
                            <allowEmptyValue>0</allowEmptyValue>
                            <width>30</width>
                            <preShowPageActionList>
                                <getFreePort>
                                    <finalPort>9999</finalPort>
                                    <initialPort>8080</initialPort>
                                    <variable>tomcatDefaultPort</variable>
                                </getFreePort>
                            </preShowPageActionList>
                        </stringParameter>
                        <booleanParameterGroup>
                            <name>advancedPlatformConfiguration</name>
                            <description>Advanced</description>
                            <explanation></explanation>
                            <value></value>
                            <default></default>
                            <validationType>ifSelected</validationType>
                            <parameterList>
                                <stringParameter>
                                    <name>platformAdmin</name>
                                    <title>Platform administrator username</title>
                                    <description>Platform admin username</description>
                                    <explanation></explanation>
                                    <value></value>
                                    <default>platformAdmin</default>
                                    <allowEmptyValue>0</allowEmptyValue>
                                    <width>30</width>
                                </stringParameter>
                                <passwordParameter>
                                    <name>platformPassword</name>
                                    <title>Platform administrator password</title>
                                    <description>Platform admin password</description>
                                    <explanation></explanation>
                                    <value></value>
                                    <default>platformPassword</default>
                                    <allowEmptyValue>0</allowEmptyValue>
                                    <askForConfirmation>0</askForConfirmation>
                                    <descriptionRetype>Confirm password</descriptionRetype>
                                    <width>20</width>
                                </passwordParameter>
                            </parameterList>
                        </booleanParameterGroup>
                    </parameterList>
                </parameterGroup>
                <parameterGroup>
                    <name>defaultTenantConfig</name>
                    <title>Default Tenant Configuration</title>
                    <explanation></explanation>
                    <value></value>
                    <default></default>
                    <parameterList>
                        <stringParameter>
                            <name>tenantadminusername</name>
                            <title>Set the default tenant username</title>
                            <description>Username</description>
                            <explanation></explanation>
                            <value></value>
                            <default>living</default>
                            <allowEmptyValue>0</allowEmptyValue>
                            <width>30</width>
                        </stringParameter>
                        <passwordParameter>
                            <name>tenantadminpassword</name>
                            <title>Tenant admin password</title>
                            <description>Password</description>
                            <explanation></explanation>
                            <value></value>
                            <default></default>
                            <allowEmptyValue>0</allowEmptyValue>
                            <descriptionRetype>Confirm password</descriptionRetype>
                            <width>20</width>
                        </passwordParameter>
                    </parameterList>
                </parameterGroup>
                <choiceParameter>
                    <name>dbVendor</name>
                    <title>db.vendor.title</title>
                    <description>db.vendor.description</description>
                    <explanation>db.vendor.description</explanation>
                    <value></value>
                    <default>h2</default>
                    <allowEmptyValue>0</allowEmptyValue>
                    <displayType>radiobuttons</displayType>
                    <ordering>default</ordering>
                    <width>30</width>
                    <optionList>
                        <option>
                            <description>${msg(h2.option.description)}</description>
                            <image>${build_project_directory}/img/h2.png</image>
                            <text>H2</text>
                            <value>h2</value>
                        </option>
                        <option>
                            <description>${msg(postgres.option.description)}</description>
                            <image>${build_project_directory}/img/postgresql.png</image>
                            <text>PostgreSQL</text>
                            <value>postgres</value>
                        </option>
                    </optionList>
                    <postShowPageActionList>
                        <if>
                            <actionList>
                                <setInstallerVariable>
                                    <name>jdbc.driver</name>
                                    <value>org.h2.Driver</value>
                                </setInstallerVariable>
                                <setInstallerVariable>
                                    <name>jdbc.url</name>
                                    <value>jdbc:h2:tcp://localhost:9091/bonita_journal.db;MVCC=TRUE;DB_CLOSE_ON_EXIT=TRUE;IGNORECASE=TRUE;</value>
                                </setInstallerVariable>
                            </actionList>
                            <conditionRuleList>
                                <compareValues>
                                    <logic>equals</logic>
                                    <value1>${dbVendor}</value1>
                                    <value2>h2</value2>
                                </compareValues>
                            </conditionRuleList>
                            <elseActionList>
                                <setInstallerVariable>
                                    <name>jdbc.driver</name>
                                    <value>org.postgresql.Driver</value>
                                </setInstallerVariable>
                                <setInstallerVariable>
                                    <name>jdbc.url</name>
                                    <value>jdbc:postgresql://localhost:${postgres_port}/${postgres_db_name}</value>
                                </setInstallerVariable>
                            </elseActionList>
                        </if>
                    </postShowPageActionList>
                </choiceParameter>
                <parameterGroup>
                    <name>db_parameter_group</name>
                    <title>Database details</title>
                    <explanation></explanation>
                    <value></value>
                    <default></default>
                    <parameterList>
                        <stringParameter>
                            <name>dbUsername</name>
                            <description>Username</description>
                            <explanation></explanation>
                            <value></value>
                            <default>${default_db_username}</default>
                            <allowEmptyValue>0</allowEmptyValue>
                            <width>30</width>
                        </stringParameter>
                        <passwordParameter>
                            <name>dbPassword</name>
                            <description>Password</description>
                            <explanation></explanation>
                            <value></value>
                            <default></default>
                            <allowEmptyValue>0</allowEmptyValue>
                            <descriptionRetype>Confirm</descriptionRetype>
                            <width>20</width>
                        </passwordParameter>
                    </parameterList>
                    <preShowPageActionList>
                        <setInstallerVariable>
                            <name>default_db_username</name>
                            <value>sa</value>
                            <ruleList>
                                <compareValues>
                                    <logic>equals</logic>
                                    <value1>${dbVendor}</value1>
                                    <value2>h2</value2>
                                </compareValues>
                            </ruleList>
                        </setInstallerVariable>
                        <setInstallerVariable>
                            <name>default_db_username</name>
                            <value>bonita</value>
                            <ruleList>
                                <compareValues>
                                    <logic>equals</logic>
                                    <value1>${dbVendor}</value1>
                                    <value2>postgres</value2>
                                </compareValues>
                            </ruleList>
                        </setInstallerVariable>
                    </preShowPageActionList>
                </parameterGroup>
                <parameterGroup>
                    <name>postgres_parameter_group</name>
                    <title>PostgreSQL configuration</title>
                    <explanation></explanation>
                    <value></value>
                    <default></default>
                    <parameterList>
                        <stringParameter>
                            <name>postgres_db_name</name>
                            <description>Bonita database name</description>
                            <explanation></explanation>
                            <value></value>
                            <default>bonita</default>
                            <allowEmptyValue>0</allowEmptyValue>
                            <width>30</width>
                        </stringParameter>
                        <stringParameter>
                            <name>postgres_port</name>
                            <description>Port</description>
                            <explanation></explanation>
                            <value></value>
                            <default>${postgres_default_port}</default>
                            <allowEmptyValue>0</allowEmptyValue>
                            <width>30</width>
                        </stringParameter>
                    </parameterList>
                    <preShowPageActionList>
                        <getFreePort>
                            <finalPort>9999</finalPort>
                            <initialPort>5432</initialPort>
                            <variable>postgres_default_port</variable>
                        </getFreePort>
                    </preShowPageActionList>
                    <ruleList>
                        <compareValues>
                            <logic>equals</logic>
                            <value1>${dbVendor}</value1>
                            <value2>postgres</value2>
                        </compareValues>
                    </ruleList>
                </parameterGroup>
            </parameterList>
            <postInstallationActionList>
                <copyFile>
                    <destination>${installdir}</destination>
                    <origin>/home/emmanuel/_work/living-day-2-innovation-week/bonitabpmplatforminstaller-1.0/bundle.zip</origin>
                </copyFile>
                <unzip>
                    <destinationDirectory>${installdir}</destinationDirectory>
                    <zipFile>${installdir}/bundle.zip</zipFile>
                </unzip>
                <propertiesFileSet>
                    <explanation>Updating bonita default Tenant username</explanation>
                    <file>${installdir}/BonitaBPMCommunity-6.3.2-Tomcat-6.0.37/bonita/client/platform/conf/platform-tenant-config.properties</file>
                    <key>platform.tenant.default.username</key>
                    <value>${tenantadminusername}</value>
                </propertiesFileSet>
                <propertiesFileSet>
                    <explanation>Updating bonita default Tenant password</explanation>
                    <file>${installdir}/BonitaBPMCommunity-6.3.2-Tomcat-6.0.37/bonita/client/platform/conf/platform-tenant-config.properties</file>
                    <key>platform.tenant.default.password</key>
                    <value>${tenantadminpassword}</value>
                </propertiesFileSet>
                <propertiesFileSet>
                    <explanation>Updating bonita Platform username</explanation>
                    <file>${installdir}/BonitaBPMCommunity-6.3.2-Tomcat-6.0.37/bonita/server/platform/conf/bonita-platform.properties</file>
                    <key>platformAdminUsername</key>
                    <value>${platformAdmin}</value>
                </propertiesFileSet>
                <propertiesFileSet>
                    <explanation>Updating bonita Platform password</explanation>
                    <file>${installdir}/BonitaBPMCommunity-6.3.2-Tomcat-6.0.37/bonita/server/platform/conf/bonita-platform.properties</file>
                    <key>platformAdminPassword</key>
                    <value>${platformPassword}</value>
                </propertiesFileSet>
                <propertiesFileSet>
                    <explanation>Updating bonita default Tenant username</explanation>
                    <file>${installdir}/BonitaBPMCommunity-6.3.2-Tomcat-6.0.37/bonita/server/platform/tenant-template/conf/bonita-server.properties</file>
                    <key>userName</key>
                    <value>${tenantadminusername}</value>
                </propertiesFileSet>
                <propertiesFileSet>
                    <explanation>Updating bonita default Tenant password</explanation>
                    <file>${installdir}/BonitaBPMCommunity-6.3.2-Tomcat-6.0.37/bonita/server/platform/tenant-template/conf/bonita-server.properties</file>
                    <key>userPassword</key>
                    <value>${tenantadminpassword}</value>
                </propertiesFileSet>
                <substitute>
                    <files>${installdir}/BonitaBPMCommunity-6.3.2-Tomcat-6.0.37/bin/setenv.sh</files>
                    <type>regexp</type>
                    <substitutionList>
                        <substitution>
                            <pattern>h2</pattern>
                            <value>${dbVendor}</value>
                        </substitution>
                    </substitutionList>
                </substitute>
                <xmlFileSet>
                    <attribute>username</attribute>
                    <element>//Context/Resource[@name="bonitaSequenceManagerDS"]</element>
                    <file>${installdir}/BonitaBPMCommunity-6.3.2-Tomcat-6.0.37/conf/Catalina/localhost/bonita.xml</file>
                    <value>${dbUsername}</value>
                </xmlFileSet>
                <xmlFileSet>
                    <attribute>password</attribute>
                    <element>//Context/Resource[@name="bonitaSequenceManagerDS"]</element>
                    <file>${installdir}/BonitaBPMCommunity-6.3.2-Tomcat-6.0.37/conf/Catalina/localhost/bonita.xml</file>
                    <value>${dbPassword}</value>
                </xmlFileSet>
                <addTextToFile>
                    <file>${installdir}/BonitaBPMCommunity-6.3.2-Tomcat-6.0.37/bin/setenv.sh</file>
                    <text>export JRE_HOME=${jre_home}</text>
                    <ruleList>
                        <compareValues>
                            <logic>equals</logic>
                            <negate>1</negate>
                            <value1>${jre_home}</value1>
                            <value2></value2>
                        </compareValues>
                    </ruleList>
                </addTextToFile>
            </postInstallationActionList>
            <startMenuShortcutList>
                <startMenuShortcut>
                    <comment>Uninstall ${product_fullname}</comment>
                    <name>Uninstall ${product_fullname}</name>
                    <runAsAdmin>0</runAsAdmin>
                    <runInTerminal>0</runInTerminal>
                    <windowsExec>${installdir}/${uninstallerName}.exe</windowsExec>
                    <windowsExecArgs></windowsExecArgs>
                    <windowsIcon></windowsIcon>
                    <windowsPath>${installdir}/</windowsPath>
                </startMenuShortcut>
            </startMenuShortcutList>
        </component>
    </componentList>
    <preInstallationActionList>
        <setInstallerVariable>
            <name>jre_home</name>
            <value></value>
        </setInstallerVariable>
    </preInstallationActionList>
    <allowComponentSelection>1</allowComponentSelection>
    <componentsDirectory>.</componentsDirectory>
    <enableRollback>1</enableRollback>
    <enableTimestamp>1</enableTimestamp>
    <vendor>Bonitasoft</vendor>
    <customLanguageFileList>
        <language>
            <code>en</code>
            <encoding>utf-8</encoding>
            <file>${build_project_directory}/I18n/messages.properties</file>
        </language>
    </customLanguageFileList>
</project>

